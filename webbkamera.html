<html>
    <head>
        <meta charset="utf-8">
        <title>Webbkamera</title>
        <link rel="stylesheet" href="css/webcam.css">
    </head>
    <body>
        <!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Stubben – HôlaCam</title>
</head>
<body>
  <h1>Stubben</h1>
  <div class="webcam-wrapper">
    <canvas id="webcam-container" width="640" height="360"></canvas>
  </div>
  <div id="webcam-status">Uppdaterar...</div>
  <button class="back-btn" onclick="history.back()">⬅ Tillbaka</button>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const canvas = document.getElementById("webcam-container");
      const ctx = canvas.getContext("2d");
      const statusDiv = document.getElementById("webcam-status");

      const baseImage = new Image();
      baseImage.src = "images/stubbe.jpg";

      const updateInterval = 5000;
      const fps = 1000 / updateInterval;

      let weather = null;
      let weatherDuration = 0;
      let lensDrops = [];

      baseImage.onload = () => {
        updateWebcam();
        setInterval(updateWebcam, updateInterval);
      };

      baseImage.onerror = () => {
        console.warn("Kunde inte hitta stubben.");
        setInterval(updateWebcam, updateInterval);
      };

      function updateWebcam() {
        ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
        applyDaylight();
        updateWeather();
        drawNoise();
        drawOverlay();
        drawScanlines();

        const now = new Date();
        const timestamp = now.toLocaleTimeString("sv-SE");
        const viewers = 10 + Math.floor(Math.random() * 50);

        statusDiv.textContent =
          `Senast uppdaterad: ${timestamp} | Uppdateringsintervall: ${updateInterval/1000}s | FPS: ${fps} | Tittare: ${viewers}`;
      }

      function applyDaylight() {
        const now = new Date();
        const hour = now.getHours();
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        let brightness = 1;
        let tint = [0, 0, 0];
        let nightvision = false;

        if (hour >= 22 || hour < 6) {
          brightness = 0.5;
          nightvision = true;
        } else if (hour >= 6 && hour < 9) {
          brightness = 0.8;
          tint = [80, 70, 40];
        } else if (hour >= 18 && hour < 22) {
          brightness = 0.7;
          tint = [60, 50, 80];
        }

        for (let i = 0; i < data.length; i += 4) {
          let r = data[i];
          let g = data[i + 1];
          let b = data[i + 2];

          if (nightvision) {
            const avg = (r + g + b) / 3;
            r = avg * 0.2;
            g = avg * 0.9;
            b = avg * 0.2;
          } else {
            r = r * brightness + tint[0];
            g = g * brightness + tint[1];
            b = b * brightness + tint[2];
          }

          data[i] = Math.min(255, r);
          data[i + 1] = Math.min(255, g);
          data[i + 2] = Math.min(255, b);
        }

        ctx.putImageData(imageData, 0, 0);
      }

      function updateWeather() {
        const now = new Date();
        const month = now.getMonth() + 1;

        if (!weather && Math.random() < 0.1) {
          if (month >= 11 || month <= 2) {
            weather = "snow";
          } else if (month >= 4 && month <= 9) {
            weather = "rain";
          }
          if (weather) weatherDuration = 3 + Math.floor(Math.random() * 5);
        }

        if (weather === "rain") {
          drawRain();
          drawLensDrops();
        }
        if (weather === "snow") drawSnow();

        if (weather) {
          weatherDuration--;
          if (weatherDuration <= 0) {
            weather = null;
            lensDrops = [];
          }
        }
      }

      function drawRain() {
        ctx.save();
        ctx.strokeStyle = "rgba(180,180,255,0.4)";
        ctx.lineWidth = 1.2;
        for (let i = 0; i < 60; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const len = 10 + Math.random() * 15;
          const angle = Math.PI / 2 + (Math.random() - 0.5) * 0.2; // slight angle
          ctx.globalAlpha = 0.3 + Math.random() * 0.3;
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(
            x + Math.cos(angle) * len,
            y + Math.sin(angle) * len
          );
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
        ctx.restore();

        if (Math.random() < 0.05 && lensDrops.length < 5) {
          lensDrops.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: 10 + Math.random() * 20,
            life: 5 + Math.floor(Math.random() * 10)
          });
        }
      }

      function drawLensDrops() {
        lensDrops.forEach((drop, i) => {
          const gradient = ctx.createRadialGradient(
            drop.x, drop.y, drop.r * 0.2,
            drop.x, drop.y, drop.r
          );
          gradient.addColorStop(0, "rgba(200,200,255,0.2)");
          gradient.addColorStop(1, "rgba(200,200,255,0)");

          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(drop.x, drop.y, drop.r, 0, Math.PI * 2);
          ctx.fill();

          drop.life--;
          if (drop.life <= 0) lensDrops.splice(i, 1);
        });
      }

      function drawSnow() {
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        for (let i = 0; i < 30; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          ctx.beginPath();
          ctx.arc(x, y, 2 + Math.random() * 2, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function drawNoise() {
        const count = 200;
        ctx.fillStyle = "rgba(255,255,255,0.05)";
        for (let i = 0; i < count; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          ctx.fillRect(x, y, 1, 1);
        }
      }

      function drawOverlay() {
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(5, canvas.height - 25, 120, 20);

        ctx.fillStyle = "#0f0";
        ctx.font = "12px Courier New";
        ctx.fillText("HôlaCam 9737", 10, canvas.height - 10);
      }

      function drawScanlines() {
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        for (let y = 0; y < canvas.height; y += 2) {
          ctx.fillRect(0, y, canvas.width, 1);
        }
      }
    });
  </script>

    </body>
</html>