<html>
    <head>
        <meta charset="utf-8">
        <title>Webbkamera</title>
        <link rel="stylesheet" href="css/webcam.css">
        <script src="webcam.js" defer></script>
    </head>
    <body>
        <h1>Stubben</h1>
        <canvas id="webcam-container" width="640" height="360"></canvas>
        <div id="webcam-status">Uppdaterar...</div>
        <button class="back-button" onclick="window.history.back()">← Tillbaka</button>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById("webcam-container");
            const ctx = canvas.getContext("2d");
            const statusDiv = document.getElementById("webcam-status");

            const baseImage = new Image();
            baseImage.src = "images/stubbe.jpg";

            const updateInterval = 20000; // 20 sek
            const fps = 15;

            let weather = null;
            let weatherDuration = 0;
            let imageLoaded = false;

            baseImage.onload = () => {
                imageLoaded = true;
                updateWebcam();
            };

            setInterval(updateWebcam, updateInterval);
            updateWebcam();

            function updateWebcam() {
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (imageLoaded) {
                ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
                applyDaylight();
                applyDynamicNoise();
                updateWeather();
                }

                drawOverlay();

                const now = new Date();
                const timestamp = now.toLocaleTimeString("sv-SE");
                const viewers = 10 + Math.floor(Math.random() * 50);

                statusDiv.textContent =
                `Senast uppdaterad: ${timestamp} | Uppdateringsintervall: ${updateInterval/1000}s | FPS: ${fps} | Tittare: ${viewers}`;
            }

            function applyDaylight() {
                const now = new Date();
                const hour = now.getHours();
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                if (hour >= 22 || hour < 6) {
                // Nightvision
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const green = avg * 1.2; // blekare än tidigare
                    data[i] = 0;
                    data[i + 1] = Math.min(255, green);
                    data[i + 2] = 0;
                }
                ctx.putImageData(imageData, 0, 0);
                drawScanlines();
                } else if (hour >= 6 && hour < 9) {
                tintImage(data, 0.8, [80, 70, 40]); // morgon
                ctx.putImageData(imageData, 0, 0);
                } else if (hour >= 18 && hour < 22) {
                tintImage(data, 0.7, [60, 50, 80]); // skymning
                ctx.putImageData(imageData, 0, 0);
                }
            }

            function tintImage(data, brightness, tint) {
                for (let i = 0; i < data.length; i += 4) {
                data[i]     = Math.min(255, data[i] * brightness + tint[0]);
                data[i + 1] = Math.min(255, data[i + 1] * brightness + tint[1]);
                data[i + 2] = Math.min(255, data[i + 2] * brightness + tint[2]);
                }
            }

            function drawScanlines() {
                ctx.strokeStyle = "rgba(0,255,0,0.1)";
                for (let y = 0; y < canvas.height; y += 2) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
                }
            }

            function applyDynamicNoise() {
                // Slumpa ljusstyrkan lite (som om kameran kämpar med autoexponering)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const noiseStrength = 0.05 + Math.random() * 0.05;

                for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * 50 * noiseStrength;
                data[i]     = Math.min(255, Math.max(0, data[i] + noise));
                data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
                data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));
                }

                ctx.putImageData(imageData, 0, 0);

                // Glitch-effekt: dra en liten del av bilden i sidled ibland
                if (Math.random() < 0.1) {
                const glitchY = Math.floor(Math.random() * canvas.height);
                const glitchHeight = 5 + Math.floor(Math.random() * 10);
                const slice = ctx.getImageData(0, glitchY, canvas.width, glitchHeight);
                ctx.putImageData(slice, Math.random() * 10 - 5, glitchY);
                }
            }

            function updateWeather() {
                const now = new Date();
                const month = now.getMonth() + 1;

                if (!weather && Math.random() < 0.1) {
                if (month >= 11 || month <= 2) {
                    weather = "snow";
                } else if (month >= 4 && month <= 9) {
                    weather = "rain";
                }
                if (weather) weatherDuration = 3 + Math.floor(Math.random() * 5);
                }

                if (weather === "rain") drawRain();
                if (weather === "snow") drawSnow();

                if (weather) {
                weatherDuration--;
                if (weatherDuration <= 0) weather = null;
                }
            }

            function drawRain() {
                ctx.strokeStyle = "rgba(180,180,255,0.6)";
                ctx.lineWidth = 1;
                for (let i = 0; i < 80; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const len = 8 + Math.random() * 12;
                const tilt = Math.random() * 2;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + tilt, y + len);
                ctx.stroke();
                }
            }

            function drawSnow() {
                ctx.fillStyle = "rgba(255,255,255,0.85)";
                for (let i = 0; i < 40; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                ctx.beginPath();
                ctx.arc(x, y, 2 + Math.random() * 3, 0, Math.PI * 2);
                ctx.fill();
                }
            }

            function drawOverlay() {
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.fillRect(5, canvas.height - 25, 140, 20);

                ctx.fillStyle = "#0f0";
                ctx.font = "12px Courier New";
                ctx.fillText("HôlaCam-2003", 10, canvas.height - 10);
            }
            });
        </script>

    </body>
</html>